# Gremlins

![Gizmo](https://github.com/ch3rn0byl/Gremlins/blob/master/Images/Gremlins-Gizmo-square.png)

This application and driver was made to aid for Research and Development purposes in regards to monitoring and fuzzing. The logic for fuzzing is not yet implemented. What this does _not_ do is bypass any security mitigations for malicious behavior. All work that has been put into it as of now has been developed targetting Windows Enterprise 20h2 x64. 
## Requirements
1. Windows SDK
2. Windows WDK

This was compiled using Visual Studio 2019's C++17 compiler.

## Hooking
As of now, this will hook the following API's: `nt!NtCreateFile` and `nt!NtDeviceIoControlFile`. The application will resolve all syscalls for any target function you are interested in hooking. The hook is as follows:
```
mov rax, hooked_address
jmp rax
```

The hooking implementation, itself, is bare minimum meaning it will only print the arguments and buffer if there is any. At this point, the function is yours to play with. 

## How does this work?
#### Usermode Application: Gizmo
Gizmo is a usermode application will resolve the syscall for a function using LoadLibrary and then scan that region of memory until it hits the syscall signature. Once the syscall signature is found, it will extract that number and return it. The syscall value is of type UINT16. Gizmo will then forward that information to Gremlins. 

#### Kernel Driver: Gremlins
Gremlins is a kernel driver that will do all the processing. Gremlins will do the following:
1. Check if it's initialized or not.
2. Initialize itself. What this will do is gather all the information needed for the other functions to work correctly. 
3. Check if a given syscall is hooked.
4. If the syscall is not hooked, it will hook it. 
5. If a syscall is hooked, it will restore it. 
Gremlins will first resolve `nt!KiSystemServiceUser` by querying the LSTAR register. Once that is found, it will search KiSystemServiceUser for `nt!KeServiceDescriptorTable`. From there, it has the values for the ServiceTableBase and the amount of services available. 

Gremlins will process the data from Gizmo and then retrieve the function that correlates to that specific syscall index. Gremlins will then convert the virtual address to physical address that way we can double map the physical address into userspace as Read/Write. The patch is applied and the secondary address is unmapped. The Nt function is now hooked, all without the need to modify CR0.[WP].

It uses a LIST_ENTRY to hold the hooked functions data. Doing it this way makes it easier for Gremlins to keep track of whats hooked and what is not hooked. The only limitation of the number of hooks you can use is limited to what you're willing to do and whatever the amount is, if any, of the amount of items LIST_ENTRY's can hold. 

## How to use?
Since this is purely for Research and Development purposes, I make use of `nt!DbgPrint` to see the output of the system therefore being connected to your kernel debugger instance is a must; however, I don't enforce it in Gizmo. It will just pause but you will have no idea what is happening. 

A service will need to be created and started with the Service Controller Manager:
```
sc create gremlins binPath= <path to driver>/gremlins.sys type= kernel
sc start gremlins
```
If you want it to automatically at boot, you can use:
```
sc create gremlins binPath= <path to driver>/gremlins.sys type= kernel start= auto
```

To be able to view the output generated by Gremlins inside of WinDbg, use the following command to do so otherwise you will _not_ see anything:
```
ed nt!Kd_Default_Mask 8
```

After that is done, you will use Gizmo to interact with the driver:
```
Gizmo.exe --hook NtDeviceIoControlFile
Gizmo.exe --restore NtCreateFile
```

or multiple hooks at the same time:
```
Gizmo.exe --hook NtDeviceIoControlFile NtCreateFile
Gizmo.exe --hook NtDeviceIoControlFile --restore NtCreateFile
```

![Gizmo](https://github.com/ch3rn0byl/Gremlins/blob/master/Images/Gizmo.PNG)

After placing the hook...

![Stripe](https://github.com/ch3rn0byl/Gremlins/blob/master/Images/Stripe.PNG)

